<html>
    <head>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://unpkg.com/d3-simple-slider"></script>
        <style>
            .hidden {
                display: none;
            }

            header h1 {
                margin-left: 15px;
                margin-top: 15px;
                margin-bottom: 10px;
            }

            body {
                margin: 0px;
                font-family: sans-serif;
            }

            main {
                display: flex;
                flex-direction: row;
            }

            .sidebar {
                width: 400px;
                background-color: #ffffff;
                margin-left: 15px;
                margin-top: 10px;
                margin-right: 0px;
                margin-bottom: 0px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .filters {
                display: flex;
                flex-direction: column;
                background-color: #6c87e0;
                margin: 0px;
                width: 400px;
                border-radius: 5px;

            }

            .filters svg {
                align-self: center;
            }

            .filters h2, h3 {
                padding-left: 10px;
                margin-left: 10px;
                margin-bottom: 10px;
                margin-right: 0px;
            }

            .filtering_suggestion {
                display: none;
            }

            .mainarea {
                margin-top: 10px;
            }

            .result_indiv {
                background-color: #3a3a3a;
                color: white;
                margin-bottom: 10px;
                margin-left: 10px;
                padding: 5px;
                width: 700px;
                border-radius: 5px;
                cursor: pointer;
            }

            #resultnum {
                margin-left: 10px;
            }

            .popup {
                background-color: #7d7d7d;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 60%;
                height: 40%;
                border-style: solid;
                border-color: #2f2f2f;
                border-width: 4px;
                border-radius: 5px;
            }

            .barchart {
                display: flex;
                flex-wrap: wrap;
            }

            .barchart svg  {
                margin-left: 10px;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>HomeSearcher</h1>
        </header>
        <main>
            <div class="sidebar">
                <div class="filters">
                <!-- INSERT FILTERING TOOLS HERE -->
                    <h2>Filters</h2>
                    <h3>Sale Price:</h3>
                    <svg id="cost-slider-svg" width="350px" height="80px"></svg>

                    <h3>Bedrooms:</h3>
                    <svg id="bed-slider-svg" width="350px" height="80px"></svg>

                    <h3>Bathrooms:</h3>
                    <svg id="bath-slider-svg" width="350px" height="80px"></svg>
                </div>
            </div>

            <div class="mainarea">
                <div class="barchart" id="bardiv">
                    <!-- interactive bar chart at the top -->
                    <svg id="cost-bar" width="350px" height="200px"></svg>
                    <svg id="bed-bar" width="350px" height="200px"></svg>
                    <svg id="bath-bar" width="350px" height="200px"></svg>
                </div>
                <p id="resultnum"></p>
                <div class="matches" id="matches">
                    <!-- individual home suggestions -->
                </div>
                <div class="filtering_suggestion">
                    <!-- suggestion to improve search results -->
                </div>
                <div class="hidden popup" id="popup">
                    <!-- appears when you select a result -->
                    <button id="close">X</button>
                    <h3 id="title"></h3>
                    <p id="price"></p>
                    <p id="beds"></p>
                    <p id="baths"></p>
                    <p id="sqft"></p>
                    <p id="yrblt"></p>
                </div>
            </div>
        </main>

        
        <script>
            const matches_div = d3.select("#matches");
            const popup = d3.select("#popup");
            popup.select("#close").on("click", function () {
                                        popup.attr("class", "hidden popup");
                                      });

            const barchart_div = d3.select("#bardiv");
            const barwidth = barchart_div.select("#bed-bar").attr("width");
            const barheight = barchart_div.select("#bed-bar").attr("height");
            const margin = {top: 10, right: 10, bottom: 30, left: 30};
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            

            const requestData = async() => {
                const zillow_data = await d3.csv("zillow_pittsburgh.csv", d3.autoType);
                console.log(zillow_data);

            const resultCount = d3.select("#resultnum");

            

                // CREATE EXTENTS/SCALES FOR NECESSARY VARIABLES
                const costExtent = d3.extent(zillow_data, d => d['Sale Amount']);
                const bedroomExtent = d3.extent(zillow_data, d => d['Bedrooms']);
                const bathroomExtent = d3.extent(zillow_data, d => d['Bathroom']);


                // Populate bar graphs up top



                // RESULTS GENERATION

                function select_result(d) {
                    console.log("clicked");
                    popup.attr("class", "popup");
                    popup.select("#title").html(d['Street Address'] +  ", " + d['City'] + ", " + d['State'] + " " + d['Zipcode']);
                }

                function add_result(d) {
                    let result_indiv = matches_div.append("div")
                                                  .attr("class", "result_indiv")
                                                  .on("click", () => select_result(d));
                    result_indiv.append("h3").text(d['Street Address']);
                }

                let zillow_matches = zillow_data;

                function filter_adjusted() {
                    // Clear barchart annotations
                    d3.select("#cost-bar").selectAll("rect").remove();
                    d3.select("#bed-bar").selectAll("rect").remove();
                    d3.select("#bath-bar").selectAll("rect").remove();

                    zillow_matches = zillow_data;

                    matches_div.selectAll("div").remove();

                    let costSelection = costSlider.value();
                    let bedSelection = bedSlider.value();
                    let bathSelection = bathSlider.value();

                    zillow_matches = zillow_matches.filter(d => (d['Sale Amount'] >= costSelection[0] & d['Sale Amount'] <= costSelection[1]) & (d['Bedrooms'] >= bedSelection[0] & d['Bedrooms'] <= bedSelection[1]) & (d['Bathroom'] >= bathSelection[0] & d['Bathroom'] <= bathSelection[1]));

                    zillow_matches.forEach( d => {add_result(d);});

                    resultCount.text(zillow_matches.length + " results");

                    if(zillow_matches.length <= 5) {
                        // Find attribute with the lowest number of results individually
                        let recommendation = d3.min([
                            zillow_matches.filter(d => (d['Sale Amount'] >= costSelection[0] & d['Sale Amount'] <= costSelection[1]).length),
                            zillow_matches.filter(d => (d['Bedrooms'] >= bedSelection[0] & d['Bedrooms'] <= bedSelection[1]).length), 
                            zillow_matches.filter(d => (d['Bathroom'] >= bathSelection[0] & d['Bathroom'] <= bathSelection[1]).length)
                        ]);

                        // Highlight/unhighlight bar graphs to show user what they are missing

                        d3.select("#cost-bar").append("rect")
                                            .attr("x", 0)
                                            .attr("y", 0)
                                            .attr("width", barwidth)
                                            .attr("height", barheight)
                                            .attr("fill", "grey");

                        d3.select("#bed-bar").append("rect")
                                            .attr("x", 0)
                                            .attr("y", 0)
                                            .attr("width", barwidth)
                                            .attr("height", barheight)
                                            .attr("fill", "grey");

                        d3.select("#bath-bar").append("rect")
                                            .attr("x", 0)
                                            .attr("y", 0)
                                            .attr("width", barwidth)
                                            .attr("height", barheight)
                                            .attr("fill", "grey");

                    }
                }


                zillow_matches.forEach( d => {
                    d['match_pct'] = 100;
                });


                // CREATE SLIDERS
                // Cost slider
                const costSlider = d3.sliderBottom()
                                     .min(costExtent[0])
                                     .max(costExtent[1])
                                     .width(300)
                                     .ticks(6)
                                     .tickFormat(d3.format(".2s"))
                                     .default([costExtent[0],costExtent[1]])
                                     .fill("lightgrey");

                costSlider.on('onchange', filter_adjusted);

                const costSliderG = d3.select("#cost-slider-svg")
                                      .append('g')
                                      .attr('transform', 'translate(25, 20)');
                costSliderG.call(costSlider);

                // Bedroom slider
                const bedSlider = d3.sliderBottom()
                                     .min(bedroomExtent[0])
                                     .max(bedroomExtent[1])
                                     .width(300)
                                     .ticks(bedroomExtent[1]-bedroomExtent[0])
                                     .default([bedroomExtent[0],bedroomExtent[1]])
                                     .step(1)
                                     .fill("lightgrey");

                bedSlider.on('onchange', filter_adjusted);

                const bedSliderG = d3.select("#bed-slider-svg")
                                      .append('g')
                                      .attr('transform', 'translate(25, 20)');
                bedSliderG.call(bedSlider);

                // Bathroom slider
                const bathSlider = d3.sliderBottom()
                                     .min(bathroomExtent[0])
                                     .max(bathroomExtent[1])
                                     .width(300)
                                     .ticks(6)
                                     .step(0.5)
                                     .default([bathroomExtent[0],bathroomExtent[1]])
                                     .fill("lightgrey");

                bathSlider.on('onchange', filter_adjusted);

                const bathSliderG = d3.select("#bath-slider-svg")
                                      .append('g')
                                      .attr('transform', 'translate(25, 20)');
                bathSliderG.call(bathSlider);

                filter_adjusted();


            }
            requestData();
        </script>
    </body>
</html>